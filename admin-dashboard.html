<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Admin | Noble Acabamentos</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "voz8860kq1");
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-58G5330J5L"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-58G5330J5L');
    </script>

    <style>
        :root {
            --primary: #2d3436;
            --accent: #d35400;
            --accent-gradient: linear-gradient(135deg, #d35400 0%, #e67e22 100%);
            --bg: #f0f2f5;
            --sidebar-bg: #1e272e;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #2d3436;
            --text-muted: #636e72;
            --white: #ffffff;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 15px rgba(0, 0, 0, 0.1);
            --glass-border: rgba(255, 255, 255, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Background */
        .glass-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgba(211, 84, 0, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(52, 152, 219, 0.05) 0%, transparent 40%);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: var(--white);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 3rem;
            padding: 0 0.5rem;
        }

        .logo-area img {
            height: 40px;
            filter: drop-shadow(0 0 8px rgba(211, 84, 0, 0.3));
        }

        .logo-text {
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .logo-text span {
            color: var(--accent);
        }

        .nav-menu {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.85rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            color: #bdc3c7;
            text-decoration: none;
        }

        .nav-item i {
            width: 20px;
            height: 20px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--accent-gradient);
            color: var(--white);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(211, 84, 0, 0.3);
        }

        .nav-item.active i {
            stroke-width: 3px;
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1.5rem;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem 3rem;
            transition: margin-left 0.3s ease;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
        }

        .welcome-text h1 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .welcome-text p {
            color: var(--text-muted);
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(8px);
        }

        .admin-profile img {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        .stat-icon.revenue {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .stat-icon.orders {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info);
        }

        .stat-icon.customers {
            background: rgba(211, 84, 0, 0.1);
            color: var(--accent);
        }

        .stat-icon.products {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* Charts Section */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(12px);
            min-height: 350px;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Recent Activity Table */
        .data-section {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(12px);
            margin-bottom: 2.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: var(--white);
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(211, 84, 0, 0.4);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #ddd;
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: #f8f9fa;
        }

        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }

        .custom-table th {
            text-align: left;
            padding: 1rem;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .custom-table td {
            padding: 1.2rem 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
            vertical-align: middle;
        }

        .custom-table tr:last-child td {
            border-bottom: none;
        }

        .status-pill {
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-paid {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .status-shipped {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info);
        }

        .status-cancelled {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        .customer-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .customer-avatar {
            width: 32px;
            height: 32px;
            background: #eee;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--accent);
        }

        /* Loading Animation */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #f7f7f7 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Hide sections */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--white);
            width: 90%;
            max-width: 800px;
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 1.5rem 0.5rem;
            }

            .logo-text,
            .nav-item span,
            .sidebar-footer span {
                display: none;
            }

            .main-content {
                margin-left: 80px;
                padding: 1.5rem;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .nav-item {
                justify-content: center;
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                bottom: 0;
                top: auto;
                width: 100%;
                height: 60px;
                flex-direction: row;
                padding: 0;
            }

            .logo-area,
            .sidebar-footer {
                display: none;
            }

            .nav-menu {
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
            }

            .nav-item {
                padding: 0;
                background: none !important;
                box-shadow: none !important;
                transform: none !important;
            }

            .main-content {
                margin-left: 0;
                padding-bottom: 80px;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .admin-profile {
                align-self: flex-end;
            }
        }
    </style>
</head>

<body>
    <div class="glass-bg"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-area">
            <img src="assets/logo_na.png" alt="Noble Acabamentos">
            <div class="logo-text">NOBLE<span>.</span>ADS</div>
        </div>

        <nav class="nav-menu">
            <a href="#" class="nav-item active" data-tab="overview">
                <i data-lucide="layout-dashboard"></i>
                <span>Geral</span>
            </a>
            <a href="#" class="nav-item" data-tab="orders">
                <i data-lucide="shopping-bag"></i>
                <span>Pedidos</span>
            </a>
            <a href="#" class="nav-item" data-tab="products">
                <i data-lucide="package"></i>
                <span>Produtos</span>
            </a>
            <a href="#" class="nav-item" data-tab="customers">
                <i data-lucide="users"></i>
                <span>Clientes</span>
            </a>
            <a href="#" class="nav-item" data-tab="marketing">
                <i data-lucide="megaphone"></i>
                <span>Marketing</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="painel.html" class="nav-item" style="margin-bottom: 0.5rem; background: rgba(255,255,255,0.05);">
                <i data-lucide="arrow-left"></i>
                <span>Minha Conta</span>
            </a>
            <div class="nav-item" onclick="handleLogout()">
                <i data-lucide="log-out"></i>
                <span>Sair</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header>
            <div class="welcome-text">
                <h1 id="page-title">Power Dashboard</h1>
                <p id="current-date">Domingo, 1 de Março de 2026</p>
            </div>
            <div class="admin-profile" style="gap: 1.5rem; padding: 0.75rem 1.5rem;">
                <div
                    style="display: flex; align-items: center; gap: 0.75rem; border-right: 1px solid #ddd; padding-right: 1.5rem;">
                    <i data-lucide="calendar" style="width: 18px; color: var(--text-muted);"></i>
                    <input type="date" id="filter-start" class="btn-outline"
                        style="padding: 0.3rem; border-radius: 6px; font-size: 0.85rem;">
                    <span style="color: var(--text-muted); font-size: 0.8rem;">até</span>
                    <input type="date" id="filter-end" class="btn-outline"
                        style="padding: 0.3rem; border-radius: 6px; font-size: 0.85rem;">
                    <button class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;"
                        onclick="loadData()">Filtrar</button>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="text-align: right;">
                        <div style="font-weight: 700; font-size: 0.9rem;" id="admin-name">Admin Noble</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Administrador</div>
                    </div>
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Noble" alt="Avatar">
                </div>
            </div>
        </header>

        <!-- Tab: Overview -->
        <section id="tab-overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon revenue"><i data-lucide="dollar-sign"></i></div>
                    <div class="stat-label">Receita Total</div>
                    <div class="stat-value" id="stat-revenue">R$ 0,00</div>
                    <div class="stat-trend trend-up"><i data-lucide="trending-up"></i> 12.5% acm. mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orders"><i data-lucide="shopping-cart"></i></div>
                    <div class="stat-label">Pedidos</div>
                    <div class="stat-value" id="stat-orders">0</div>
                    <div class="stat-trend trend-up"><i data-lucide="trending-up"></i> 8.2% este mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon customers"><i data-lucide="user-plus"></i></div>
                    <div class="stat-label">Novos Clientes</div>
                    <div class="stat-value" id="stat-customers">0</div>
                    <div class="stat-trend trend-down"><i data-lucide="trending-down"></i> 2.4% vs mês ant.</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon products"><i data-lucide="box"></i></div>
                    <div class="stat-label">Produtos Ativos</div>
                    <div class="stat-value" id="stat-products">0</div>
                    <div class="stat-trend"><i data-lucide="minus"></i> Estável</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Desempenho de Vendas</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline"
                                style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Mensal</button>
                            <button class="btn btn-outline"
                                style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Anual</button>
                        </div>
                    </div>
                    <div style="flex: 1; position: relative; min-height: 250px;">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Distribuição por Categoria</div>
                    </div>
                    <div style="flex: 1; position: relative; min-height: 250px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">Produtos Mais Vendidos</div>
                </div>
                <div id="top-products-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <!-- Via JS -->
                </div>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">Pedidos Recentes</div>
                    <button class="btn btn-outline" onclick="switchTab('orders')">Ver Todos</button>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>ID / Cliente</th>
                            <th>Data</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Envio</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="recent-orders-list">
                        <!-- Via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Tab: Orders -->
        <section id="tab-orders" class="tab-content">
            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">Gerenciar Pedidos</div>
                    <div style="display: flex; gap: 1rem;">
                        <div class="admin-profile" style="background: rgba(0,0,0,0.03); border: none;">
                            <i data-lucide="search" style="width: 18px; color: var(--text-muted);"></i>
                            <input type="text" placeholder="Buscar pedido..."
                                style="background: none; border: none; outline: none; font-family: inherit; font-size: 0.9rem;"
                                id="order-search">
                        </div>
                        <button class="btn btn-primary" onclick="loadAllOrders()"><i
                                data-lucide="refresh-cw"></i></button>
                    </div>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Data</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="full-orders-list">
                        <!-- Via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Tab: Products -->
        <section id="tab-products" class="tab-content">
            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">Catálogo de Produtos</div>
                    <button class="btn btn-primary" onclick="openProductModal()"><i data-lucide="plus"></i> Novo
                        Produto</button>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Marca / Cor</th>
                            <th>Categoria</th>
                            <th>Preço</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="full-products-list">
                        <!-- Via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <section id="tab-customers" class="tab-content">
            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">Base de Clientes</div>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Telefone</th>
                            <th>Pedidos</th>
                            <th>Total Gasto</th>
                        </tr>
                    </thead>
                    <tbody id="customers-list">
                        <!-- Via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <section id="tab-marketing" class="tab-content">
            <div class="charts-row">
                <div class="chart-container" style="grid-column: span 2;">
                    <div class="chart-header">
                        <div class="chart-title">Vendas por Região (Top Estados)</div>
                    </div>
                    <div style="flex: 1; position: relative; min-height: 300px;">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="data-section">
                <div class="section-header">
                    <div class="section-title">Insights de Clientes</div>
                </div>
                <div id="marketing-insights"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div class="stat-card" style="background: rgba(52, 152, 219, 0.05);">
                        <div class="stat-label">Ticket Médio</div>
                        <div class="stat-value" id="insight-avg-ticket">R$ 0,00</div>
                    </div>
                    <div class="stat-card" style="background: rgba(39, 174, 96, 0.05);">
                        <div class="stat-label">Taxa de Conversão</div>
                        <div class="stat-value">3.2%</div>
                    </div>
                    <div class="stat-card" style="background: rgba(155, 89, 182, 0.05);">
                        <div class="stat-label">Retenção</div>
                        <div class="stat-value">18%</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal: Product Edit/Add -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <i data-lucide="x" class="close-modal" onclick="closeProductModal()"></i>
            <h2 id="modal-title" style="margin-bottom: 2rem;">Editar Produto</h2>
            <form id="product-form">
                <input type="hidden" id="p-id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome do Produto</label>
                        <input type="text" id="p-name"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Marca</label>
                        <input type="text" id="p-brand"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Cor</label>
                        <input type="text" id="p-color"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Categoria</label>
                        <select id="p-category"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="terminal">Terminal</option>
                            <option value="conexao">Conexão</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Preço (R$)</label>
                        <input type="number" step="0.01" id="p-price"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">URL da Imagem</label>
                        <input type="text" id="p-image"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Descrição</label>
                    <textarea id="p-desc" rows="4"
                        style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd; font-family: inherit;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeProductModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Customer Edit -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <i data-lucide="x" class="close-modal" onclick="closeCustomerModal()"></i>
            <h2 id="c-modal-title" style="margin-bottom: 2rem;">Gerenciar Cliente</h2>
            <form id="customer-form">
                <input type="hidden" id="c-id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="grid-column: span 2;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome Completo</label>
                        <input type="text" id="c-name"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">E-mail</label>
                        <input type="email" id="c-email"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Telefone</label>
                        <input type="text" id="c-phone"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">CPF/CNPJ</label>
                        <input type="text" id="c-cpf"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Função (Role)</label>
                        <select id="c-role"
                            style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="customer">Cliente</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: space-between;">
                    <button type="button" class="btn btn-outline"
                        style="color: var(--danger); border-color: var(--danger);" onclick="deleteCustomer()">Excluir
                        Perfil</button>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-outline" onclick="closeCustomerModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://xpoktmqxmgduginmqojf.supabase.co';
        const SUPABASE_ANON_KEY =
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhwb2t0bXF4bWdkdWdpbm1xb2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3ODUyODMsImV4cCI6MjA4NzM2MTI4M30.Zkn5oXvHzqAvOyIrEUQeRLFto_dibEQo9ynBqtidQv8';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let salesChart, categoryChart;
        let allProducts = [], allOrders = [], allCustomers = [];

        // Initialization
        async function init() {
            lucide.createIcons();
            updateDate();

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            // Verify admin role
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (!profile || profile.role !== 'admin') {
                alert('Acesso restrito ao administrador.');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('admin-name').textContent = profile.full_name || 'Admin Noble';

            // Set default dates (start of month to today)
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('filter-start').value = firstDay.toISOString().split('T')[0];
            document.getElementById('filter-end').value = now.toISOString().split('T')[0];

            await loadData();
            setupTabListeners();
        }

        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR', options);
        }

        async function loadData() {
            const startDate = document.getElementById('filter-start').value;
            const endDate = document.getElementById('filter-end').value;

            // Format end date to include full day
            const endDateTime = endDate + 'T23:59:59';

            // Load Products (Not filtered by date for stats, but used for category chart)
            const { data: products } = await supabaseClient.from('products').select('*');
            allProducts = products || [];
            document.getElementById('stat-products').textContent = allProducts.length;

            // Load Orders (Filtered by date)
            const { data: orders } = await supabaseClient
                .from('orders')
                .select('*, profiles(full_name, email)')
                .gte('created_at', startDate)
                .lte('created_at', endDateTime)
                .order('created_at', { ascending: false });
            allOrders = orders || [];
            document.getElementById('stat-orders').textContent = allOrders.length;

            // Load Customers (Fetch all for the "Base de Clientes")
            const { data: profiles } = await supabaseClient
                .from('profiles')
                .select('*');
            allCustomers = profiles || [];

            // Calculate "New Customers" stat (Created within period)
            const newCustomers = allCustomers.filter(c => {
                const created = new Date(c.created_at || c.updated_at);
                return created >= new Date(startDate) && created <= new Date(endDateTime);
            }).length;

            document.getElementById('stat-customers').textContent = newCustomers;

            // Calculate Revenue
            const revenue = allOrders
                .filter(o => o.status === 'pago' || o.status === 'enviado')
                .reduce((acc, curr) => acc + Number(curr.total_amount), 0);

            document.getElementById('stat-revenue').textContent = `R$ ${revenue.toLocaleString('pt-BR', {
                minimumFractionDigits: 2, maximumFractionDigits: 2
            })}`;

            renderRecentOrders();
            renderAllOrders();
            renderCharts();
            renderProducts();
            renderCustomers();
            renderTopProducts();
        }

        function renderAllOrders() {
            const tbody = document.getElementById('full-orders-list');
            if (!tbody) return;
            tbody.innerHTML = '';

            allOrders.forEach(order => {
                const customerName = order.profiles ? order.profiles.full_name : 'N/A';
                const date = new Date(order.created_at).toLocaleString('pt-BR');

                tbody.innerHTML += `
        <tr>
            <td style="font-weight: 600;">#${order.id.slice(0, 8).toUpperCase()}</td>
            <td style="font-size: 0.9rem;">${customerName}</td>
            <td style="font-size: 0.9rem;">${date}</td>
            <td style="font-weight: 700;">R$ ${Number(order.total_amount).toFixed(2).replace('.', ',')}</td>
            <td><span class="status-pill status-${order.status}">${order.status}</span></td>
            <td>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-outline" style="padding: 0.4rem;" onclick="viewOrder('${order.id}')">
                        <i data-lucide="eye" style="width: 16px;"></i>
                    </button>
                    ${order.status === 'pago' ? `<button class="btn btn-primary"
                        style="padding: 0.4rem; background: var(--success);"
                        onclick="generateLabel('${order.id}', event)" title="Gerar Etiqueta"><i data-lucide="truck"
                            style="width: 16px;"></i></button>` : order.status === 'enviado' ? `<a
                        href="${order.label_url}" target="_blank" class="btn btn-outline"
                        style="padding: 0.4rem; color: var(--success);" title="Imprimir Etiqueta"><i
                            data-lucide="printer" style="width: 16px;"></i></a>` : ''}
                </div>
            </td>
        </tr>
        `;
            });
            lucide.createIcons();
        }

        async function viewOrder(id) {
            const order = allOrders.find(o => o.id === id);
            if (!order) return;

            // Get order items - We need to fetch from order_items table
            const { data: items } = await supabaseClient
                .from('order_items')
                .select('*')
                .eq('order_id', id);

            const itemsHtml = items.map(item => `
        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 0.75rem 0;">
            <div>
                <div style="font-weight: 600;">${item.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${item.brand} | ${item.color} | Qtd:
                    ${item.quantity}</div>
            </div>
            <div style="font-weight: 600;">R$ ${(item.price * item.quantity).toFixed(2).replace('.', ',')}</div>
        </div>
        `).join('');

            const alertHtml = `
        <div style="text-align: left;">
            <h3 style="margin-bottom: 1rem;">Pedido #${order.id.slice(0, 8).toUpperCase()}</h3>
            <div style="margin-bottom: 1.5rem; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <p><strong>Cliente:</strong> ${order.profiles?.full_name || 'N/A'}</p>
                <p><strong>E-mail:</strong> ${order.profiles?.email || 'N/A'}</p>
                <p><strong>Status:</strong> <span class="status-pill status-${order.status}">${order.status}</span></p>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <h4
                    style="font-size: 0.9rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem;">
                    Produtos</h4>
                ${itemsHtml}
            </div>
            <div style="text-align: right; font-size: 1.25rem;">
                <strong>Total: R$ ${Number(order.total_amount).toFixed(2).replace('.', ',')}</strong>
            </div>
        </div>
        `;

            // Use existing modal or a quick alert overlay
            const modal = document.getElementById('productModal');
            document.getElementById('modal-title').textContent = 'Detalhes do Pedido';
            document.getElementById('product-form').style.display = 'none';
            const detailView = document.createElement('div');
            detailView.id = 'order-detail-view';
            detailView.innerHTML = alertHtml + '<div style="margin-top:2rem; text-align:right;"><button class="btn btn-outline" onclick="closeOrderModal()">Fechar</button></div>';

            const modalContent = modal.querySelector('.modal-content');
            const existingDetail = document.getElementById('order-detail-view');
            if (existingDetail) existingDetail.remove();
            modalContent.appendChild(detailView);

            modal.style.display = 'flex';
        }

        function closeOrderModal() {
            document.getElementById('productModal').style.display = 'none';
            document.getElementById('product-form').style.display = 'block';
            const detailView = document.getElementById('order-detail-view');
            if (detailView) detailView.remove();
        }

        async function generateLabel(orderId, event) {
            if (!confirm('Deseja gerar a etiqueta para este pedido?')) return;

            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="refresh-cw" class="animate-spin" style="width: 16px;"></i>';
            btn.disabled = true;

            try {
                const response = await fetch('/.netlify/functions/melhorenvio-label', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Etiqueta gerada com sucesso!');
                    loadData();
                } else {
                    throw new Error(result.error || 'Erro ao gerar etiqueta');
                }
            } catch (err) {
                alert('Erro: ' + err.message);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        async function loadAllOrders() {
            const btn = event.currentTarget;
            const icon = btn.querySelector('i');
            icon.classList.add('animate-spin'); // Simplified spin
            await loadData();
            icon.classList.remove('animate-spin');
        }

        // Search Orders
        document.getElementById('order-search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allOrders.filter(o =>
                o.id.toLowerCase().includes(term) ||
                (o.profiles && o.profiles.full_name.toLowerCase().includes(term)) ||
                (o.profiles && o.profiles.email.toLowerCase().includes(term))
            );

            const tbody = document.getElementById('full-orders-list');
            tbody.innerHTML = '';
            filtered.forEach(order => {
                // ... same template as renderAllOrders (refactor would be better but let's keep it simple for now)
                const customerName = order.profiles ? order.profiles.full_name : 'N/A';
                const date = new Date(order.created_at).toLocaleString('pt-BR');
                tbody.innerHTML += `
        <tr>
            <td style="font-weight: 600;">#${order.id.slice(0, 8).toUpperCase()}</td>
            <td style="font-size: 0.9rem;">${customerName}</td>
            <td style="font-size: 0.9rem;">${date}</td>
            <td style="font-weight: 700;">R$ ${Number(order.total_amount).toFixed(2).replace('.', ',')}</td>
            <td><span class="status-pill status-${order.status}">${order.status}</span></td>
            <td>
                <button class="btn btn-outline" style="padding: 0.4rem;" onclick="viewOrder('${order.id}')">
                    <i data-lucide="eye" style="width: 16px;"></i>
                </button>
            </td>
        </tr>
        `;
            });
            lucide.createIcons();
        });

        function renderRecentOrders() {
            const tbody = document.getElementById('recent-orders-list');
            tbody.innerHTML = '';

            allOrders.slice(0, 5).forEach(order => {
                const customerName = order.profiles ? order.profiles.full_name : 'Cliente Visitante';
                const initials = customerName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                const date = new Date(order.created_at).toLocaleDateString('pt-BR');

                tbody.innerHTML += `
        <tr>
            <td>
                <div class="customer-info">
                    <div class="customer-avatar">${initials}</div>
                    <div>
                        <div style="font-weight: 600;">#${order.id.slice(0, 8).toUpperCase()}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${customerName}</div>
                    </div>
                </div>
            </td>
            <td style="font-size: 0.9rem;">${date}</td>
            <td style="font-weight: 700;">R$ ${Number(order.total_amount).toFixed(2).replace('.', ',')}</td>
            <td><span class="status-pill status-${order.status}">${order.status}</span></td>
            <td style="font-size: 0.85rem;">${order.shipping_method_name || 'N/A'}</td>
            <td>
                <button class="btn btn-outline" style="padding: 0.4rem;" onclick="viewOrder('${order.id}')">
                    <i data-lucide="eye" style="width: 16px;"></i>
                </button>
            </td>
        </tr>
        `;
            });
            lucide.createIcons();
        }

        function renderProducts() {
            const tbody = document.getElementById('full-products-list');
            tbody.innerHTML = '';

            allProducts.forEach(p => {
                tbody.innerHTML += `
        <tr>
            <td>
                <div class="customer-info">
                    <img src="${p.image_url || 'assets/product_placeholder.jpg'}"
                        style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
                    <div style="font-weight: 600;">${p.name}</div>
                </div>
            </td>
            <td>
                <div style="font-size: 0.9rem;">${p.brand}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">${p.color}</div>
            </td>
            <td><span
                    style="font-size: 0.85rem; background: #eee; padding: 0.2rem 0.5rem; border-radius: 4px;">${p.category
                    || 'N/A'}</span></td>
            <td style="font-weight: 700;">R$ ${Number(p.price).toFixed(2).replace('.', ',')}</td>
            <td>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-outline" style="padding: 0.4rem;" onclick="editProduct('${p.id}')">
                        <i data-lucide="edit-3" style="width: 16px;"></i>
                    </button>
                    <button class="btn btn-outline" style="padding: 0.4rem; color: var(--danger);"
                        onclick="deleteProduct('${p.id}')">
                        <i data-lucide="trash-2" style="width: 16px;"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
            });
            lucide.createIcons();
        }

        function renderCustomers() {
            const tbody = document.getElementById('customers-list');
            tbody.innerHTML = '';

            allCustomers.forEach(c => {
                // Find stats for this customer
                const orders = allOrders.filter(o => o.user_id === c.id);
                const totalSpent = orders.reduce((acc, curr) => acc + Number(curr.total_amount), 0);
                const email = c.email || 'N/A';

                tbody.innerHTML += `
        <tr>
            <td style="font-weight: 600; color: var(--accent); cursor: pointer;" onclick="openCustomerModal('${c.id}')">
                ${c.full_name || 'N/A'}</td>
            <td style="font-size: 0.9rem;">${email}</td>
            <td style="font-size: 0.9rem;">${c.phone || 'N/A'}</td>
            <td>${orders.length}</td>
            <td style="font-weight: 700;">R$ ${totalSpent.toFixed(2).replace('.', ',')}</td>
        </tr>
        `;
            });
        }

        function renderCharts() {
            // Sales Chart (Last 6 Months Mocking Data for visuals)
            const ctxSales = document.getElementById('salesChart').getContext('2d');

            if (salesChart) salesChart.destroy();

            // Process month-by-month sales from allOrders - Sorted chronologically
            const stats = {};
            allOrders.forEach(o => {
                if (o.status === 'pago' || o.status === 'enviado') {
                    const d = new Date(o.created_at);
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    const label = d.toLocaleString('pt-BR', { month: 'short' });
                    if (!stats[key]) stats[key] = { label, total: 0 };
                    stats[key].total += Number(o.total_amount);
                }
            });

            // Sort keys to ensure chronological order
            const sortedKeys = Object.keys(stats).sort();
            const last6Keys = sortedKeys.slice(-6);

            const labels = last6Keys.map(k => stats[k].label);
            const data = last6Keys.map(k => stats[k].total);

            salesChart = new Chart(ctxSales, {
                type: 'line',
                data: {
                    labels: labels.length ? labels : ['Set', 'Out', 'Nov', 'Dez', 'Jan', 'Fev'],
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: data.length ? data : [1200, 1900, 3000, 5000, 2300, 3400],
                        borderColor: '#d35400',
                        borderWidth: 4,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const { ctx, chartArea } = chart;
                            if (!chartArea) return null;
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            gradient.addColorStop(0, 'rgba(211, 84, 0, 0)');
                            gradient.addColorStop(1, 'rgba(211, 84, 0, 0.1)');
                            return gradient;
                        },
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#d35400',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { callback: value => 'R$ ' + value }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Category Chart
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();

            const categories = {};
            allProducts.forEach(p => {
                categories[p.category] = (categories[p.category] || 0) + 1;
            });

            categoryChart = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#d35400', '#2d3436', '#3498db', '#27ae60'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { family: 'Outfit', size: 12 } }
                        }
                    }
                }
            });
        }

        // Tab Switching
        function setupTabListeners() {
            document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = item.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function switchTab(tabId) {
            // Update UI
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Update Title
            const titles = {
                overview: 'Power Dashboard',
                orders: 'Gerenciamento de Pedidos',
                products: 'Catálogo de Produtos',
                customers: 'Clientes & Insights',
                marketing: 'Campanhas de Marketing'
            };
            document.getElementById('page-title').textContent = titles[tabId];

            if (tabId === 'overview') renderCharts();
            if (tabId === 'marketing') renderMarketing();
        }

        let regionChart;
        function renderMarketing() {
            const ctxRegion = document.getElementById('regionChart').getContext('2d');
            if (regionChart) regionChart.destroy();

            // Calculate sales by state from allOrders
            const regions = {};
            allOrders.forEach(o => {
                if (o.status === 'pago' || o.status === 'enviado') {
                    const state = o.shipping_address_state || 'N/A';
                    regions[state] = (regions[state] || 0) + Number(o.total_amount);
                }
            });

            const sortedRegions = Object.entries(regions).sort((a, b) => b[1] - a[1]).slice(0, 5);

            regionChart = new Chart(ctxRegion, {
                type: 'bar',
                data: {
                    labels: sortedRegions.map(r => r[0]),
                    datasets: [{
                        label: 'Vendas por Estado (R$)',
                        data: sortedRegions.map(r => r[1]),
                        backgroundColor: '#d35400',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Avg Ticket
            const paidOrders = allOrders.filter(o => o.status === 'pago' || o.status === 'enviado');
            const totalRevenue = paidOrders.reduce((acc, curr) => acc + Number(curr.total_amount), 0);
            const avgTicket = paidOrders.length ? totalRevenue / paidOrders.length : 0;
            document.getElementById('insight-avg-ticket').textContent = `R$ ${avgTicket.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        }

        async function renderTopProducts() {
            const grid = document.getElementById('top-products-grid');
            grid.innerHTML = '<p style="color: var(--text-muted);">Carregando top produtos...</p>';

            grid.innerHTML = '';
            allProducts.slice(0, 4).forEach(p => {
                grid.innerHTML += `
                    <div class="stat-card" style="padding: 1rem; text-align: center;">
                        <img src="${p.image_url || 'assets/product_placeholder.jpg'}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin: 0 auto 0.5rem;">
                        <div style="font-weight: 700; font-size: 0.85rem; height: 2.5rem; overflow: hidden;">${p.name}</div>
                        <div style="color: var(--accent); font-weight: 800; font-size: 0.9rem; margin-top: 0.5rem;">R$ ${Number(p.price).toFixed(2).replace('.', ',')}</div>
                    </div>
                `;
            });
        }

        // Product CRUD Functions
        function openProductModal(id = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('product-form');
            form.reset();
            document.getElementById('p-id').value = '';

            if (id) {
                const p = allProducts.find(prod => prod.id === id);
                if (p) {
                    title.textContent = 'Editar Produto';
                    document.getElementById('p-id').value = p.id;
                    document.getElementById('p-name').value = p.name;
                    document.getElementById('p-brand').value = p.brand;
                    document.getElementById('p-color').value = p.color;
                    document.getElementById('p-category').value = p.category;
                    document.getElementById('p-price').value = p.price;
                    document.getElementById('p-image').value = p.image_url;
                    document.getElementById('p-desc').value = p.description;
                }
            } else {
                title.textContent = 'Novo Produto';
            }

            modal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('p-id').value;
            const productData = {
                name: document.getElementById('p-name').value,
                brand: document.getElementById('p-brand').value,
                color: document.getElementById('p-color').value,
                category: document.getElementById('p-category').value,
                price: parseFloat(document.getElementById('p-price').value),
                image_url: document.getElementById('p-image').value,
                description: document.getElementById('p-desc').value
            };

            if (id) {
                await supabaseClient.from('products').update(productData).eq('id', id);
            } else {
                await supabaseClient.from('products').insert([productData]);
            }

            closeProductModal();
            loadData();
        };

        async function deleteProduct(id) {
            if (confirm('Deseja realmente excluir este produto?')) {
                await supabaseClient.from('products').delete().eq('id', id);
                loadData();
            }
        }

        function editProduct(id) {
            openProductModal(id);
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        }

        function openCustomerModal(id) {
            const modal = document.getElementById('customerModal');
            const c = allCustomers.find(cust => cust.id === id);
            if (!c) return;

            document.getElementById('c-id').value = c.id;
            document.getElementById('c-name').value = c.full_name || '';
            document.getElementById('c-email').value = c.email || '';
            document.getElementById('c-phone').value = c.phone || '';
            document.getElementById('c-cpf').value = c.cpf_cnpj || '';
            document.getElementById('c-role').value = c.role || 'customer';

            modal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').style.display = 'none';
        }

        document.getElementById('customer-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('c-id').value;
            const customerData = {
                full_name: document.getElementById('c-name').value,
                email: document.getElementById('c-email').value,
                phone: document.getElementById('c-phone').value,
                cpf_cnpj: document.getElementById('c-cpf').value,
                role: document.getElementById('c-role').value
            };

            const { error } = await supabaseClient
                .from('profiles')
                .update(customerData)
                .eq('id', id);

            if (error) {
                alert('Erro ao atualizar: ' + error.message);
            } else {
                closeCustomerModal();
                loadData();
            }
        };

        async function deleteCustomer() {
            const id = document.getElementById('c-id').value;
            if (confirm('Deseja realmente excluir este perfil? Esta ação não remove o login do usuário, apenas os dados do perfil.')) {
                await supabaseClient.from('profiles').delete().eq('id', id);
                closeCustomerModal();
                loadData();
            }
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>