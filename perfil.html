<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil | Noble Acabamentos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/jpeg" href="assets/favicon.jpg">

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "voz8860kq1");
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-58G5330J5L"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-58G5330J5L');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .profile-container {
            padding-top: 150px;
            padding-bottom: 100px;
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-card {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .form-group input {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
        }

        .full-width {
            grid-column: span 2;
        }

        .btn-save {
            margin-top: 2rem;
            width: 100%;
            font-size: 1.1rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
    </style>
    <!-- Meta Pixel Code -->
    <script>
        !function (f, b, e, v, n, t, s) {
            if (f.fbq) return; n = f.fbq = function () {
                n.callMethod ?
                    n.callMethod.apply(n, arguments) : n.queue.push(arguments)
            };
            if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0';
            n.queue = []; t = b.createElement(e); t.async = !0;
            t.src = v; s = b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t, s)
        }(window, document, 'script',
            'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1542888320142112', {}, { test_event_code: 'TEST59151' });
        fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
            src="https://www.facebook.com/tr?id=1542888320142112&ev=PageView&noscript=1" /></noscript>
    <!-- End Meta Pixel Code -->
    <meta name="facebook-domain-verification" content="gapdb4ujdop8ynkqs1qaz6s0umy13n" />
</head>

<body>
    <div id="loading" class="loading-overlay">Carregando...</div>
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="logo">
                    <img src="assets/logo_na.png" alt="Noble Acabamentos Logo" style="height: 50px;">
                    <div class="logo-text">
                        <span class="noble">NOBLE</span>
                        <span class="acabamentos">ACABAMENTOS</span>
                    </div>
                </a>
                <button class="mobile-menu-btn" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <ul class="nav-links">
                    <li><a href="index.html">Início</a></li>
                    <li><a href="loja.html">Loja</a></li>
                    <li id="auth-link"></li>
                    <li>
                        <a href="carrinho.html" class="cart-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="9" cy="21" r="1" />
                                <circle cx="20" cy="21" r="1" />
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                            </svg>
                            <span id="cart-count" class="cart-count">0</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container profile-container">
        <div class="profile-card">
            <h1>Completar Cadastro</h1>
            <p>Preencha seus dados para entrega e emissão de nota fiscal.</p>

            <form id="profile-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="full_name" required>
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="email" readonly style="background: #f8f9fa; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>CPF ou CNPJ</label>
                        <input type="text" id="cpf_cnpj" placeholder="000.000.000-00" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone/WhatsApp</label>
                        <input type="text" id="phone" placeholder="(00) 00000-0000" required>
                    </div>
                    <div class="form-group">
                        <label>CEP</label>
                        <input type="text" id="cep" placeholder="00000-000" onblur="lookupCEP()" required>
                    </div>
                    <div class="form-group">
                        <label>Estado (UF)</label>
                        <input type="text" id="uf" maxlength="2" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Cidade</label>
                        <input type="text" id="cidade" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Logradouro (Rua/Avenida)</label>
                        <input type="text" id="logradouro" required>
                    </div>
                    <div class="form-group">
                        <label>Número</label>
                        <input type="text" id="numero" required>
                    </div>
                    <div class="form-group">
                        <label>Bairro</label>
                        <input type="text" id="bairro" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Complemento (Opcional)</label>
                        <input type="text" id="complemento">
                    </div>
                </div>
                <button type="submit" class="btn btn-save">Salvar e Continuar</button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xpoktmqxmgduginmqojf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhwb2t0bXF4bWdkdWdpbm1xb2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3ODUyODMsImV4cCI6MjA4NzM2MTI4M30.Zkn5oXvHzqAvOyIrEUQeRLFto_dibEQo9ynBqtidQv8';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        async function init() {
            const loader = document.getElementById('loading');
            loader.style.display = 'flex';

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = 'login.html?redirect=perfil.html';
                return;
            }
            currentUser = user;

            // Busca perfil existente
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profile) {
                document.getElementById('full_name').value = profile.full_name || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('cpf_cnpj').value = profile.cpf_cnpj || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('cep').value = profile.cep || '';
                document.getElementById('logradouro').value = profile.logradouro || '';
                document.getElementById('numero').value = profile.numero || '';
                document.getElementById('complemento').value = profile.complemento || '';
                document.getElementById('bairro').value = profile.bairro || '';
                document.getElementById('cidade').value = profile.cidade || '';
                document.getElementById('uf').value = profile.uf || '';
            } else {
                // If no profile yet, at least fill the email from auth
                document.getElementById('email').value = user.email || '';
                document.getElementById('full_name').value = user.user_metadata?.full_name || '';
            }

            loader.style.display = 'none';
        }

        async function lookupCEP() {
            const cepInput = document.getElementById('cep');
            let cep = cepInput.value.replace(/\D/g, '');

            // Aplica mascara no CEP
            if (cep.length > 5) {
                cepInput.value = cep.slice(0, 5) + '-' + cep.slice(5, 8);
            }

            if (cep.length !== 8) return;

            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await res.json();
                if (!data.erro) {
                    document.getElementById('logradouro').value = data.logradouro;
                    document.getElementById('bairro').value = data.bairro;
                    document.getElementById('cidade').value = data.localidade;
                    document.getElementById('uf').value = data.uf;
                    document.getElementById('numero').focus();
                }
            } catch (err) {
                console.error('Erro ao buscar CEP:', err);
            }
        }

        // Mascaras simples
        document.getElementById('cpf_cnpj').oninput = function (e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length <= 11) {
                v = v.replace(/(\d{3})(\d)/, '$1.$2');
                v = v.replace(/(\d{3})(\d)/, '$1.$2');
                v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                v = v.replace(/^(\d{2})(\d)/, '$1.$2');
                v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
                v = v.replace(/(\d{4})(\d)/, '$1-$2');
            }
            e.target.value = v;
        };

        document.getElementById('phone').oninput = function (e) {
            let v = e.target.value.replace(/\D/g, '');
            v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
            v = v.replace(/(\d)(\d{4})$/, '$1-$2');
            e.target.value = v;
        };

        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            const loader = document.getElementById('loading');
            loader.style.display = 'flex';

            const formData = {
                full_name: document.getElementById('full_name').value,
                email: currentUser.email,
                cpf_cnpj: document.getElementById('cpf_cnpj').value,
                phone: document.getElementById('phone').value,
                cep: document.getElementById('cep').value,
                logradouro: document.getElementById('logradouro').value,
                numero: document.getElementById('numero').value,
                complemento: document.getElementById('complemento').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                uf: document.getElementById('uf').value,
                updated_at: new Date()
            };

            const { error } = await supabaseClient
                .from('profiles')
                .upsert({ id: currentUser.id, ...formData });

            loader.style.display = 'none';

            if (error) {
                alert('Erro ao salvar perfil: ' + error.message);
            } else {
                const urlParams = new URLSearchParams(window.location.search);
                const redirect = urlParams.get('redirect') || 'loja.html';
                window.location.href = redirect;
            }
        };

        init();
    </script>
    <!-- Botão Flutuante WhatsApp -->
    <a href="https://wa.me/5548988799001" class="whatsapp-float" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
            <path
                d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z" />
        </svg>
    </a>
</body>

</html>